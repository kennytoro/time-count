pipeline {
    agent any

    environment {
        // where we define the variables to use
        IMAGE_NAME = 'kennytoro/stopwatch'
        IMAGE_TAG = "${IMAGE_NAME}:${BUILD_NUMBER}"
    }

    triggers {
        pollSCM '* * * * *'
    }

    stages {

        stage('Login to docker hub') {
            steps {
                sh "cat passwd | docker login -u kennytoro --password-stdin"
                echo " Docker login in successfully"
            }
        }

        stage('Building the Image') {
            steps {
                sh "docker build . -t ${IMAGE_NAME}"
                sh " docker build . -t ${IMAGE_TAG}"
                sh " docker images"
            }
        }

        stage('Pushing the image') {
            steps {
                sh "docker push ${IMAGE_NAME}"
                echo "Docker pushed successful"
            }
        }

        stage('Testing') {
            steps {
                sh "docker image"
            }
        }

        stage('Running the image on k8s cluster') {
            steps {
                sh " kubectl apply -f ./k8s"
            }
        }

        stage('Confirm if deployment is ruuning') {
            steps {
                sh '''
                kubectl get deployment
                kubectl get svc
                kubectl get deployment
                '''
            }
        } 

    }
}